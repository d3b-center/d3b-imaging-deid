# File Deidentification

Airflow DAG at `airflow/dags/deid_dag.py`

## Aperio SVS Files

These are from-scratch new implementations of SVS deidentification after
reading 

* https://github.com/bgilbert/anonymize-slide/
* https://github.com/pearcetm/svs-deidentifier
* https://github.com/eDIMESLab/MedicalImageAnonymizer
* https://github.com/openslide/openslide-python
* and more.

See the following comments in
https://github.com/bgilbert/anonymize-slide/pull/6 for what that
commonly-referenced tool does wrong:

  1. https://github.com/bgilbert/anonymize-slide/pull/6#issuecomment-702452302
  2. https://github.com/bgilbert/anonymize-slide/pull/6#issuecomment-877307002
  3. https://github.com/bgilbert/anonymize-slide/pull/6#issuecomment-879459090
  4. https://github.com/bgilbert/anonymize-slide/pull/6#issuecomment-880057800

The others do variants of the same.

SVS deidentification scripts do bad things because the format is not properly
documented. People rely on the OpenSlide project and its documentation, but
OpenSlide's description of the format is currently wrong.

For example, OpenSlide says:

```
label
      optional, the name “label” is given in ImageDescription

macro
      optional, the name “macro” is given in ImageDescription
```

(https://web.archive.org/web/20210914203240/https://openslide.org/formats/aperio/)

But Leica says:

> On the GT450, the Image Description value for macro and label layers empty. To
> detect the macro and label layers, it is recommended to use the
> TIFFTAG_SUBFILETYPE tag. The macro layer will always have a value of 9, and the
> label layer will always have a value of 1. This applies to both images
> generated by the AT2 and the GT450

(https://github.com/openslide/openslide/issues/297#issuecomment-813424628)

File format issues combined with other general programming mistakes like
terminating too early are why I wrote this.

### Scripts

Primary: `airflow/scripts/deid/nondestructive_aperio.py`

Alternate: `alternative_variants/svs/destructive_aperio.py`

#### **airflow/scripts/deid/nondestructive_aperio.py**

This module non-destructively deidentifies Aperio SVS files by writing a new
TIFF that includes only the desired parts.

It should have basically the same result as destructive_aperio.py but is done
in a different way. This way is a little slower and alters the size of the
output files but preserves the input.

#### **alternative_variants/svs/destructive_aperio.py**

This module destructively deidentifies Aperio SVS files in-place by writing 0s
over the stripped IFDs instead of writing a new file without them at all.

It should have basically the same result as nondestructive_aperio.py but is
done in a different way. This way is a little faster and does not alter the
size of the files but works directly on the input. _License is GPLv2 because
of the included TiffFile module._
